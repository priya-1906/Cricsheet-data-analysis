import os
import json
from datetime import datetime
from mysql.connector import Error
from db_connection import get_connection

def insert_ipl_matches():
    folder_path = "../cricsheet_json/ipl"
    files = os.listdir(folder_path)

    if not files:
        print("No files found in the IPL folder.")
        return

    try:
        conn = get_connection()
        cursor = conn.cursor()

        for file_name in files:
            if not file_name.endswith(".json"):
                continue

            file_path = os.path.join(folder_path, file_name)
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)

            match_id = file_name.replace(".json", "")
            info = data.get("info", {})

            team1, team2 = info.get("teams", [None, None])
            venue = info.get("venue")
            city = info.get("city")
            gender = info.get("gender")
            match_type = "LTL"  # Forcing LTL instead of T20
            competition = info.get("competition", None)
            result = info.get("outcome", {}).get("result", None)

            outcome = info.get("outcome", {})
            winner = outcome.get("winner", None)
            win_by = outcome.get("by", {})
            if isinstance(win_by, dict):
                win_by = ", ".join([f"{k} {v}" for k, v in win_by.items()])
            else:
                win_by = ""

            toss_info = info.get("toss", {})
            toss_winner = toss_info.get("winner", None)
            toss_decision = toss_info.get("decision", None)

            date_list = info.get("dates", [])
            match_date = datetime.strptime(date_list[0], "%Y-%m-%d").date() if date_list else None

            query = """
                INSERT IGNORE INTO ipl_matches (
                    match_id, match_date, venue, city, gender, match_type, competition,
                    winner, win_by, team1, team2, toss_winner, toss_decision, result
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """
            values = (
                match_id, match_date, venue, city, gender, match_type, competition,
                winner, win_by, team1, team2, toss_winner, toss_decision, result
            )

            cursor.execute(query, values)

        conn.commit()
        print("IPL match data inserted successfully.")

    except Error as e:
        print(f"Error: {e}")

    finally:
        if conn.is_connected():
            cursor.close()
            conn.close()
            print("Database connection closed.")

if __name__ == "__main__":
    print("Starting insertion into ipl_matches...")
    insert_ipl_matches()
